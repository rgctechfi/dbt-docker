# This Docker Compose file is intended for local development and adapter testing.
# For a generic, production-ready setup, refer to the `/docker` directory.
services:
  # Defines the PostgreSQL database service.
  database:
    image: postgres:15-alpine   # Use the lightweight Alpine version of Postgres 15.
    shm_size: 1gb               # Set the shared memory size to 1GB, which can improve database performance.
    environment:                # Set environment variables for the database container.
      POSTGRES_USER: "root"     # The username for the PostgreSQL database.
      POSTGRES_PASSWORD: "root" # The password for the PostgreSQL database.
      POSTGRES_DB: "dbt"        # The name of the default database to create.
    ports:                      # Map ports between the host and the container.
       - "5431:5432"            # Map port 5431 on the host to port 5432 in the container.

  # Defines the dbt development service.
  dbt_dev:
      working_dir: /app/first_project # Set the default working directory inside the container.
      build:
        context: ../..              # The build context is the root of the project.
        dockerfile: dev/docker/Dockerfile.test # The Dockerfile to use for building the image.
      entrypoint: /bin/sh           # Override the default entrypoint to a shell.
      command: -c "sleep infinity"  # Keep the container running indefinitely for development.
      volumes:
        # Mount the entire project directory from the host to /app in the container.
        # This allows for live code reloading.
        - ../..:/app
        # Use a named volume to persist the Python virtual environment.
        # This prevents the host's .venv from overwriting the container's .venv
        # and preserves installed dependencies between runs.
        - venv_data:/app/.venv
      environment:
        # Set environment variables for the dbt service.
        - DBT_PROFILES_DIR=/app      # Tell dbt where to find the profiles.yml file.
        - DBT_POSTGRES_HOST=database # The hostname of the database service.
      depends_on:
        - database                 # Ensure the database service starts before this service.

# Define the named volume used by the dbt_dev service.
volumes:
  venv_data:
